#'''
#	Widget rules
#	These define often used groups of buttons/labels etc
#'''

###Buttons to select modes/controls
<CtrlButton@GridLayout>:
	cols: 2
	b_text: 'default'
	func: 'none'
	ind: (1, 0, 0, 1)
	
	#Button
	BoxLayout:
		orientation: 'vertical'
		Button:
			text: root.b_text
			on_release: app.buttonHandler(root.func)
	
	#Indicator
	BoxLayout:
		orientation: 'vertical'
		Button:
			background_color: root.ind
			size_hint: (0.1, 1)
		
###Buttons to perform a simple action
<ActButton@BoxLayout>:
	b_text: 'default'
	func: 'none'
	
	Button:
		text: root.b_text
		on_release: app.buttonHandler(root.func)
	
###Shows the status of the local and remote threads
<ThreadList@GridLayout>:
	#Two columns
	#Indicator
	#Label
	
###Shows mission clock abd other info
<MissionInfo@ScatterLayout>:
	clock_text: '00:00:00'
	Label:
		text: root.clock_text
		bold: True
		font_size: 20

###Map widget showing terrain and rover position
<NavMap@BoxLayout>:
	map_image: app.map_img
	zoom: 1
	position: (0,0)
	size_hint: (None, None)
	map_size: image.size
	size: image.size
	#Map images are pretty big. We could perhaps find a way to speed up loading?
	AsyncImage:
		id: image
		pos: (0,0)
		size_hint: (None, None)
		size: (self.texture_size[0]*root.zoom, self.texture_size[1]*root.zoom)
		allow_stretch: True
		keep_ratio: True
		source: root.map_image
		canvas:
			Color:
				rgba: (0,0,1,1)
			Ellipse:
				pos: (root.position[0]*root.zoom, root.position[1]*root.zoom)
				size: (10, 10)

###Map controls widget showing a list of waypoints, zoom controls and a waypoint adder.
<MapControls@GridLayout>:
	cols: 3
	BoxLayout:
		Button:
			text: 'Zoom In +'
			on_press: app.nav.ids.map.zoom += 0.1
		Button:
			text: 'Zoom Out -'
			on_press: app.nav.ids.map.zoom -= 0.1
	BoxLayout:
		ScrollView:
			size_hint: (None, None)
			size: (100,320)
			pos_hint: {'center_x': 0.5, 'center_y': 0.5}
			do_scroll_x: True
			do_scroll_y: True
			GridLayout:
				cols: 1
				padding: 10
				spacing: 10
				size_hint: (None, None)
				width: 100
				Button:
					text: "hullo"
					size_hint: (None, None)
					size: (100,40)
				Button:
					text: "hullo2"
					size_hint: (None, None)
					size: (100,40)
				Button:
					text: "hullo"
					size_hint: (None, None)
					size: (100,40)
				Button:
					text: "hullo2"
					size_hint: (None, None)
					size: (100,40)
				Button:
					text: "hullo"
					size_hint: (None, None)
					size: (100,40)
				Button:
					text: "hullo2"
					size_hint: (None, None)
					size: (100,40)
				Button:
					text: "hullo"
					size_hint: (None, None)
					size: (100,40)
				Button:
					text: "hullo2"
					size_hint: (None, None)
					size: (100,40)
	BoxLayout:
		ActButton:
			b_text: 'Show Rover On Map'
			func: 'on_map'

###Screen Manager (Root Widget)
GuiScreenManager:
    AppScreen:
    NavScreen:

#'''
#	Layout for the main application
#	Including video and rover controls
#'''
	
###Master Layout Class
<AppScreen>:
	#Action bar at top of app
	name: 'app'
	BoxLayout:
		FloatLayout:
			ActionBar:
				pos_hint: {'top':1}
				ActionView:
					use_separator: True
					ActionPrevious:
						title: 'USSTROVER GUI <<< NAV'
						with_previous: False
						on_press: app.changeScreen()
					ActionGroup:
						text: 'Rover Actions'
						ActionButton:
							text: 'Connect'
						ActionButton:
							text: 'Stop'
						ActionButton:
							text: 'Save Waypoint'
							on_press: app.turnNavball()
					ActionButton:
						text: 'Settings'
						on_press: app.open_settings()

			#Layered video and controls
			FloatLayout:
			
				#Video feed in background
				Video:
					size_hint: (None,None)
					pos: (40,-45)
					size: (root.size[0]+5-2*40,root.size[1]) #damn tab alignment...
					id: videoScreen
					source: 'http://10.64.226.70:8080/?action=stream'
					state: 'play'
					allow_stretch: True
					keep_ratio: False
					on_loaded: root.ids.loadImg.color = (1,1,1,0)
					on_eos: root.ids.loadImg.color = (1,1,1,1)
				
				#Loading Image when no video is displayed
				Image:
					id: loadImg
					pos: (0,-45)
					size: (root.size[0],root.size[1])
					allow_stretch: True
					keep_ratio: False
					source: 'gui/background.jpg'
					
				#Main Window
				GridLayout:
					cols: 3
					size_hint: (None,None)
					pos: (0,-45)
					size: (root.size[0],root.size[1])
					
					#Left tabs with commands
					TabbedPanel:
						do_default_tab: False
						background_color: (0, 0, 0, 0)
						tab_pos: 'left_top'
						tab_width: (root.size[1]-45)/3
						TabbedPanelItem:
							text: 'Telemetry Data'
							Label:
								id: tele
								text: 'hello'
								bold: True
								font_size: 25
						TabbedPanelItem:
							text: 'Camera Buttons'
							BoxLayout:
								orientation: 'vertical'
								size_hint: 1,.3
								CtrlButton:
									id: ArmCam
									b_text: 'Arm Camera'
									func: 'ac'

								CtrlButton:
									id: DriveCam
									b_text: 'Drive Camera'
									func: 'dc'
						
						TabbedPanelItem:
							text: 'Navigation'
							FloatLayout:	
								BoxLayout:
									pos: (15, -25)
									size_hint: .8,1
									orientation: 'vertical'
									#This is the custom 3dBall Widget
									View:
										canvas.before:
											Color:
												rgba: 1, 1, 1, 1
											Rectangle:
												pos: self.pos
												size: (0, 0)
										id: Ball3d
										scene: 'gui/navball.obj'
										obj_scale: 1
										display_all: True
										ambiant: .9
										diffuse: 0.6
										specular: 0.1
										on_parent: self.position(0,0,0)
										mode: 'triangles'
										light_radius: 20
										nb_lights: 2
									#Placeholder
									Label:
										text: ''
									
					#Blank label to make space
					Label:
						text: ''
					
					#Right tabs with commands
					TabbedPanel:
						do_default_tab: False
						background_color: (0, 0, 0, 0)
						tab_pos: 'right_top'
						tab_width: (root.size[1]-45)/3

						TabbedPanelItem:
							text: 'Mission Info'
							ScatterLayout:
								size_hint: (1,.07)
								MissionInfo:
									id: mission

						TabbedPanelItem:
							text: 'Time Elapsed'
							BoxLayout:
								size_hint: (1,.3)
								MissionInfo:
									id: mission2
								TextInput:
									id: txt_input_time
								ActButton:
									id: submit2
									b_text: 'Enter Time'
									#func: 'none'
								
						TabbedPanelItem:
							text: 'Rover Controls'
							
#'''
#	Layout for the navigation application
#	Including mapping and path-finding controls
#'''

#This is an experimental declaration of a second screen
<NavScreen>:
	name: 'nav'
	BoxLayout:
		#Action bar at top of app
		FloatLayout:
			ActionBar:
				pos_hint: {'top':1}
				ActionView:
					use_separator: True
					ActionPrevious:
						title: 'USSTROVER NAV >>> GUI'
						with_previous: False
						on_press: app.changeScreen()
					ActionGroup:
						text: 'Rover Actions'
						ActionButton:
							text: 'Connect'
							on_press: app.nav.ids.map.zoom = 0.25 #test
						ActionButton:
							text: 'Stop'
							on_press: app.nav.ids.map.zoom = 0.35 #test
						ActionButton:
							text: 'Save Waypoint'
							on_press: app.nav.ids.map.zoom = 0.45 #test
					ActionButton:
						text: 'Settings'
						on_press: app.open_settings()

			#Layered Map
			FloatLayout:
				
				#Map
				ScrollView:
					id: scroll_map
					pos: (40,104)
					size_hint: (None, None)
					size: (root.size[0]+5-2*40,root.size[1]-150)
					NavMap:
						id: map
						
				#Controls
				BoxLayout:
					pos:(42,0)
					size_hint: (None, None)
					size: (root.size[0]-2*40.1, 104)
					MapControls:
								
				#Main Window
				GridLayout:
					cols: 3
					size_hint: (None,None)
					pos: (0,-45)
					size: (root.size[0],root.size[1])
					
					#Left tabs with commands
					TabbedPanel:
						do_default_tab: False
						background_color: (0, 0, 0, 0)
						tab_pos: 'left_top'
						tab_width: (root.size[1]-45)/3
							
						TabbedPanelItem:
							text: 'Coordinate Input'
							BoxLayout:
								orientation: 'vertical'
								size_hint: 1,.3
								TextInput:
									id: txt_input_lat
								TextInput:
									id: txt_input_long
								ActButton:
									id: DegDec
									b_text: 'Switch to Degree or Decimal Mode'
									#func: 'none'
								ActButton:
									id: Submit
									b_text: 'Enter Waypoint'
									#func: 'none'
						
						TabbedPanelItem:
							text: 'Camera Buttons'
							BoxLayout:
								orientation: 'vertical'
								size_hint: (1,.3)
								CtrlButton:
									id: ArmCam2
									b_text: 'Arm Camera'
									func: 'ac'

								CtrlButton:
									id: DriveCam2
									b_text: 'Drive Camera'
									func: 'dc'
						
						TabbedPanelItem:
							text: 'Navigation'
							BoxLayout:
								Label:
									text: 'A compass here would be good'
									
						
					
					#Blank label to make space
					Label:
						text: ''
					
					#Right tabs with commands
					TabbedPanel:
						do_default_tab: False
						background_color: (0, 0, 0, 0)
						tab_pos: 'right_top'
						tab_width: (root.size[1]-45)/3

						TabbedPanelItem:
							text: 'Mission Info'
							ScatterLayout:
								size_hint: (1,.07)
								MissionInfo:
									id: mission

						TabbedPanelItem:
							text: 'Time Elapsed'
							BoxLayout:
								size_hint: (1,.3)
								MissionInfo:
									id: mission2
								TextInput:
									id: txt_input_time
								ActButton:
									id: submit2
									b_text: 'Enter Time'
									#func: 'none'
								
								
						TabbedPanelItem:
							text: 'Rover Controls'